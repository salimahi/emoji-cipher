<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emoji Cipher™ – Puzzle</title>
  <meta name="description" content="Emoji Cipher™ is an original logic puzzle by Salimah Ismail. Decode the emojis to reveal the hidden phrase and balance the equations.">
  <meta name="author" content="Salimah Ismail">
  <meta name="copyright" content="© 2025 Salimah Ismail. Licensed under CC BY-NC-ND 4.0 International.">
  <meta name="license" content="https://creativecommons.org/licenses/by-nc-nd/4.0/">
  <style>
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
      margin: 2rem auto;
      max-width: 680px;
      line-height: 1.5;
      color: #222;
      background: #fdfdfd;
    }
    h1, h2 { text-align: center; }

    .note-box {
      background: #fff8db;
      border: 1px solid #e6d78a;
      border-radius: .5rem;
      padding: .75rem;
      margin-bottom: 1rem;
      font-size: .9rem;
    }

    .section-title{
      font-size:1rem;
      font-weight:600;
      margin:1.5rem 0 .5rem;
      text-transform:uppercase;
      letter-spacing:.03em;
      color:#444;
    }

    /* Phrase layout */
    .phrase-wrapper {
      background:#fff;
      border:1px solid #ddd;
      border-radius:.5rem;
      padding:1rem;
      box-shadow:0 1px 2px rgb(0 0 0 / .05);
      display:flex;
      flex-wrap:wrap;
      row-gap:1rem;
      column-gap:1rem;
      font-size:1.1rem;
    }

    .word-block {
      display:flex;
      flex-direction:column;
      align-items:flex-start;
    }

    .word-top-row,
    .word-bottom-row {
      display:flex;
      align-items:flex-start;
      gap:.6rem;
      flex-wrap:nowrap;
    }

    .char-stack {
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:2.4rem;
    }

    .char-input {
      width:2.4rem;
      height:2.4rem;
      font-size:1.1rem;
      text-align:center;
      font-weight:600;
      border:1.5px solid #bbb;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / 0.05);
      font-family:inherit;
    }
    .char-input::placeholder {
      color:#999;
      font-weight:400;
    }
    .char-input:focus{
      outline:none;
      border-color:#000;
    }
    .char-input[disabled]{
      background:#e6ffe6;
      border-color:#108a00;
      color:#0a4f00;
      font-weight:600;
    }

    .char-emoji {
      font-size:1.4rem;
      line-height:1.2;
      margin-top:.25rem;
    }

    .word-separator {
      font-weight:600;
      font-size:1rem;
      line-height:1;
      color:#666;
      margin-left:.5rem;
    }

    /* Equations block */
    .equations-wrapper{
      border:1px solid #ddd;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / .05);
      padding:.75rem 1rem;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:.9rem;
    }

    .equation-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:.75rem 1rem;
      padding:.75rem 0;
      border-bottom:1px solid #eee;
    }
    .equation-row:last-child{border-bottom:none;}

    .eq-left {
      display:flex;
      flex-wrap:wrap;
      gap:.75rem;
      align-items:flex-end;
    }

    .eq-stack {
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:2.4rem;
    }

    .num-input {
      width:2.4rem;
      height:2.4rem;
      font-size:1rem;
      text-align:center;
      font-weight:600;
      border:1.5px solid #bbb;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / 0.05);
      font-family:inherit;
    }
    .num-input::placeholder{
      color:#999;
      font-weight:400;
    }
    .num-input:focus{
      outline:none;
      border-color:#000;
    }
    .num-input[disabled]{
      background:#e6ffe6;
      border-color:#108a00;
      color:#0a4f00;
      font-weight:600;
    }

    .eq-op {
      font-size:1.1rem;
      font-weight:600;
      line-height:1;
      align-self:center;
    }

    .eq-target {
      font-weight:600;
    }

    .eq-result {
      font-weight:600;
      min-width:2rem;
      text-align:center;
    }
    .status-ok{color:#108a00;}
    .status-bad{color:#b00020;}

    /* Solution key */
    .solution-box {
      border:1px solid #ddd;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / .05);
      padding:1rem;
      font-size:.95rem;
      line-height:1.4;
      color:#222;
      white-space:pre-line;
    }
    .solution-line-solved {
      background:#e6ffe6;
      border-left:3px solid #108a00;
      padding:.25rem .5rem;
      border-radius:.25rem;
      margin-bottom:.5rem;
      font-weight:600;
      color:#0a4f00;
      box-shadow:0 1px 2px rgb(0 0 0 / .06) inset;
    }
    .solution-hint {
      font-size:.8rem;
      color:#666;
      margin-bottom:.5rem;
    }

    .win-box{
      margin-top:1rem;
      border-radius:.75rem;
      padding:1rem;
      font-weight:600;
      text-align:center;
      font-size:1rem;
      display:none;
      background:#e6ffe6;
      border:2px solid #108a00;
      color:#0a4f00;
      box-shadow:0 4px 10px rgb(0 0 0 / .08);
    }

    footer{
      margin-top:2rem;
      font-size:.8rem;
      text-align:center;
      color:#666;
    }
    footer a{
      color:#555;
      text-decoration:none;
    }
  </style>
</head>
<body>
  <h1>Emoji Cipher™</h1>
  <h2>A New Puzzle Game!</h2>
  <h3>by <a href="https://salimahismail.com">Salimah</a></h3>

  <div class="note-box">
    Each emoji hides a secret <b>LETTER</b> and <b>NUMBER</b>.<br>
    Every letter is unique, <i>but numbers can repeat.</i> <br>
    Unlock one and you'll get the other. <br>
    There are ten randomly generated puzzles (for now). <br>
    Good Luck!
  </div>

  <div class="section-title">Decode the Phrase</div>
  <div class="phrase-wrapper" id="phraseArea"></div>

  <div class="section-title">Crack the Math</div>
  <div class="equations-wrapper" id="equationsArea"></div>

  <div class="section-title">Solution Key (auto-fills as you solve)</div>
  <div class="solution-box" id="solutionBox">
    <div class="solution-hint">Solve any letter or number to unlock its pair:</div>
    <div id="solutionLines"></div>
  </div>

  <div class="win-box" id="winBox">
    ✅ You solved it!
  </div>

  <footer>
    Emoji Cipher™ © 2025 Salimah Ismail.<br>
    Licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0 International</a>. <br>
    <a href="https://salimahismail.com" target="_blank">https://salimahismail.com</a> 
  </footer>

  <script>
  (function(){

    // --- ALL 10 PUZZLES ----------------------------------------------------
    // For each puzzle:
    // - phrase: final solution text (used for win condition)
    // - phraseWords: array of word-arrays (each entry is emojis for that word)
    // - mapping: emoji -> {letter, number}
    // - uniqueEmojis: list of all emojis used in that puzzle
    // - equations: array of {left:[emoji,"+",emoji,...], target:number}
    //
    // Important: every letter in the phrase must have an emoji in phraseWords
    // and that emoji must appear in mapping.
    // Also we make sure each emoji appears in (or is inferable from) equations.

    const PUZZLES = [
      // 1. COOL GAME BRO
      {
        phrase: "COOL GAME BRO",
        phraseWords: [
          ["🦊","🪐","🪐","🐸"],        // COOL
          ["🚀","🌵","🎲","🔮"],        // GAME
          ["🧊","🐙","🪐"]             // BRO (B R O)
        ],
        mapping: {
          "🦊": { letter:"C", number:3 },
          "🪐": { letter:"O", number:8 },
          "🐸": { letter:"L", number:4 },
          "🚀": { letter:"G", number:7 },
          "🌵": { letter:"A", number:1 },
          "🎲": { letter:"M", number:6 },
          "🔮": { letter:"E", number:2 },
          "🧊": { letter:"B", number:5 },
          "🐙": { letter:"R", number:9 }
        },
        uniqueEmojis: ["🦊","🪐","🐸","🚀","🌵","🎲","🔮","🧊","🐙"],
        equations: [
          { left:["🦊","+","🪐"], target:11 },              //3+8
          { left:["🪐","+","🐸"], target:12 },              //8+4
          { left:["🚀","+","🌵","+","🎲"], target:14 },     //7+1+6
          { left:["🎲","+","🔮"], target:8 },              //6+2
          { left:["🧊","+","🌵"], target:6 },              //5+1
          { left:["🐙","+","🌵"], target:10 }              //9+1
        ]
      },

      // 2. IT IS NAP TIME
      {
        phrase: "IT IS NAP TIME",
        phraseWords: [
          ["🍄","🧊"],                // IT
          ["🍄","🐸"],                // IS
          ["🐙","🌵","🦊"],           // NAP
          ["🧊","🍄","🎲","🔮"]       // TIME
        ],
        // We need coverage for I,T,I,S,N,A,P,T,I,M,E
        // - 🍄 = I
        // - 🧊 = T
        // - 🐸 = S
        // - 🐙 = N
        // - 🌵 = A
        // - 🦊 = P
        // - 🎲 = M
        // - 🔮 = E
        mapping: {
          "🍄": { letter:"I", number:4 },
          "🧊": { letter:"T", number:9 },
          "🐸": { letter:"S", number:2 },
          "🐙": { letter:"N", number:5 },
          "🌵": { letter:"A", number:1 },
          "🦊": { letter:"P", number:7 },
          "🎲": { letter:"M", number:6 },
          "🔮": { letter:"E", number:3 }
        },
        uniqueEmojis: ["🍄","🧊","🐸","🐙","🌵","🦊","🎲","🔮"],
        equations: [
          { left:["🍄","+","🧊"], target:13 },     //4+9
          { left:["🐸","+","🐙"], target:7 },      //2+5
          { left:["🌵","+","🦊"], target:8 },      //1+7
          { left:["🎲","+","🔮"], target:9 },      //6+3
          { left:["🧊","+","🎲"], target:15 }      //9+6
        ]
      },

      // 3. HERBAL OR VERBAL TEA
      {
        phrase: "HERBAL OR VERBAL TEA",
        phraseWords: [
          ["🪐","🔮","🌊","🚀","🌵","🐙"],   // HERBAL
          ["🎲","🌊"],                    // OR
          ["🦊","🔮","🌊","🚀","🌵","🐙"],  // VERBAL
          ["🧊","🔮","🌵"]                // TEA
        ],
        // Letters needed: H E R B A L / O R / V E R B A L / T E A
        mapping: {
          "🪐": { letter:"H", number:4 },
          "🔮": { letter:"E", number:2 },
          "🌊": { letter:"R", number:9 },
          "🚀": { letter:"B", number:5 },
          "🌵": { letter:"A", number:1 },
          "🐙": { letter:"L", number:7 },
          "🎲": { letter:"O", number:6 },
          "🦊": { letter:"V", number:8 },
          "🧊": { letter:"T", number:3 }
        },
        uniqueEmojis: ["🪐","🔮","🌊","🚀","🌵","🐙","🎲","🦊","🧊"],
        equations: [
          { left:["🪐","+","🔮"], target:6 },              //4+2
          { left:["🌊","+","🚀"], target:14 },             //9+5
          { left:["🌵","+","🐙"], target:8 },              //1+7
          { left:["🎲","+","🌊"], target:15 },             //6+9
          { left:["🦊","+","🔮"], target:10 },             //8+2
          { left:["🧊","+","🔮","+","🌵"], target:6 }       //3+2+1
        ]
      },

      // 4. ADDICTED TO RAGEAHOL
      {
        phrase: "ADDICTED TO RAGEAHOL",
        phraseWords: [
          ["🌵","🎲","🎲","🍄","🦊","🧊","🔮","🎲"], // ADDICTED
          ["🧊","🎲"],                             // TO
          ["🌊","🌵","🚀","🔮","🌵","🐸","🎲","🐙"]  // RAGEAHOL
        ],
        // We need A D D I C T E D / T O / R A G E A H O L
        mapping: {
          "🌵": { letter:"A", number:1 },
          "🎲": { letter:"D", number:7 },
          "🍄": { letter:"I", number:4 },
          "🦊": { letter:"C", number:8 },
          "🧊": { letter:"T", number:9 },
          "🔮": { letter:"E", number:3 },
          "🌊": { letter:"R", number:5 },
          "🚀": { letter:"G", number:2 },
          "🐸": { letter:"H", number:4 },
          "🐙": { letter:"L", number:8 }
        },
        uniqueEmojis: ["🌵","🎲","🍄","🦊","🧊","🔮","🌊","🚀","🐸","🐙"],
        equations: [
          { left:["🌵","+","🎲"], target:8 },              //1+7
          { left:["🎲","+","🍄"], target:11 },             //7+4
          { left:["🦊","+","🧊"], target:17 },             //8+9
          { left:["🔮","+","🎲"], target:10 },             //3+7
          { left:["🌊","+","🌵","+","🚀"], target:8 },      //5+1+2
          { left:["🐸","+","🎲"], target:11 },             //4+7
          { left:["🎲","+","🐙"], target:15 }              //7+8
        ]
      },

      // 5. I BARELY EVEN KNOW HER  (FIXED)
{
  phrase: "I BARELY EVEN KNOW HER",
  phraseWords: [
    ["🍄"],                                         // I
    ["🚀","🌵","🌊","🔮","🐙","🧊"],                 // BARELY
    ["🔮","🎲","🔮","🪐"],                           // EVEN
    ["🦊","🪐","🐸","🦴"],                           // KNOW
    ["🐢","🔮","🌊"]                                // HER
  ],
  mapping: {
    "🍄": { letter:"I", number:4 },
    "🚀": { letter:"B", number:6 },
    "🌵": { letter:"A", number:1 },
    "🌊": { letter:"R", number:9 },
    "🔮": { letter:"E", number:2 },
    "🐙": { letter:"L", number:7 },
    "🧊": { letter:"Y", number:8 },
    "🎲": { letter:"V", number:5 },
    "🪐": { letter:"N", number:3 },
    "🦊": { letter:"K", number:4 },
    "🐸": { letter:"O", number:6 },
    "🦴": { letter:"W", number:2 },
    "🐢": { letter:"H", number:5 }
  },
  uniqueEmojis: ["🍄","🚀","🌵","🌊","🔮","🐙","🧊","🎲","🪐","🦊","🐸","🦴","🐢"],
  equations: [
    { left:["🍄","+","🚀"], target:10 },                 // 4+6
    { left:["🌵","+","🌊"], target:10 },                 // 1+9
    { left:["🔮","+","🐙","+","🧊"], target:17 },        // 2+7+8
    { left:["🔮","+","🎲"], target:7 },                  // 2+5
    { left:["🦊","+","🪐","+","🐸","+","🦴"], target:15 },// 4+3+6+2
    { left:["🐢","+","🔮"], target:7 }                   // 5+2
  ]
},


      // 6. SEND MORE KITTENS
      {
        phrase: "SEND MORE KITTENS",
        phraseWords: [
          ["🦊","🐸","🪐","🎲"],               // SEND
          ["🚀","🔮","🌵","🐸"],               // MORE
          ["🧊","🍄","🦴","🦴","🐸","🪼","🐍"] // KITTENS
        ],
        // We need S E N D / M O R E / K I T T E N S
        // Map each:
        // 🦊 S
        // 🐸 E
        // 🪐 N
        // 🎲 D
        // 🚀 M
        // 🔮 O
        // 🌵 R
        // 🧊 K
        // 🍄 I
        // 🦴 T
        // 🪼 N (again N, reuse 5)
        // 🐍 S (again S, reuse 6)
        mapping: {
          "🦊": { letter:"S", number:6 },
          "🐸": { letter:"E", number:2 },
          "🪐": { letter:"N", number:5 },
          "🎲": { letter:"D", number:4 },
          "🚀": { letter:"M", number:7 },
          "🔮": { letter:"O", number:8 },
          "🌵": { letter:"R", number:3 },
          "🧊": { letter:"K", number:9 },
          "🍄": { letter:"I", number:1 },
          "🦴": { letter:"T", number:4 },
          "🪼": { letter:"N", number:5 },
          "🐍": { letter:"S", number:6 }
        },
        uniqueEmojis: ["🦊","🐸","🪐","🎲","🚀","🔮","🌵","🧊","🍄","🦴","🪼","🐍"],
        equations: [
          { left:["🦊","+","🐸"], target:8 },                //6+2
          { left:["🐸","+","🪐","+","🎲"], target:11 },      //2+5+4
          { left:["🚀","+","🔮"], target:15 },              //7+8
          { left:["🌵","+","🐸"], target:5 },               //3+2
          { left:["🧊","+","🍄"], target:10 },              //9+1
          { left:["🦴","+","🦴"], target:8 },               //4+4
          { left:["🐸","+","🪼","+","🐍"], target:13 }       //2+5+6
        ]
      },

      // 7. CAUGHT A VIBE
      {
        phrase: "CAUGHT A VIBE",
        phraseWords: [
          ["🌵","🐙","🚀","🦊","🐸","🧊"], // CAUGHT
          ["🐙"],                        // A
          ["🎲","🔮","🪐","🦴"]          // VIBE
        ],
        // We need C A U G H T / A / V I B E
        mapping: {
          "🌵": { letter:"C", number:2 },
          "🐙": { letter:"A", number:1 },
          "🚀": { letter:"U", number:6 },
          "🦊": { letter:"G", number:7 },
          "🐸": { letter:"H", number:4 },
          "🧊": { letter:"T", number:9 },
          "🎲": { letter:"V", number:8 },
          "🔮": { letter:"I", number:3 },
          "🪐": { letter:"B", number:5 },
          "🦴": { letter:"E", number:2 }
        },
        uniqueEmojis: ["🌵","🐙","🚀","🦊","🐸","🧊","🎲","🔮","🪐","🦴"],
        equations: [
          { left:["🌵","+","🐙"], target:3 },       //2+1
          { left:["🚀","+","🦊"], target:13 },      //6+7
          { left:["🐸","+","🧊"], target:13 },      //4+9
          { left:["🎲","+","🔮"], target:11 },      //8+3
          { left:["🪐","+","🦴"], target:7 },       //5+2
          { left:["🐙","+","🎲"], target:9 }        //1+8
        ]
      },

      // 8. A CENTER FOR ANTS
      {
        phrase: "A CENTER FOR ANTS",
        phraseWords: [
          ["🐙"],                                  // A
          ["🧊","🌵","🦴","🔮","🌵","🎲"],          // CENTER
          ["🪐","🐸","🎲"],                         // FOR
          ["🐙","🦴","🔮","🚀"]                     // ANTS
        ],
        // We need A / C E N T E R / F O R / A N T S
        mapping: {
          "🐙": { letter:"A", number:1 },
          "🧊": { letter:"C", number:6 },
          "🌵": { letter:"E", number:2 },
          "🦴": { letter:"N", number:5 },
          "🔮": { letter:"T", number:9 },
          "🎲": { letter:"R", number:4 },
          "🪐": { letter:"F", number:7 },
          "🐸": { letter:"O", number:8 },
          "🚀": { letter:"S", number:3 }
        },
        uniqueEmojis: ["🐙","🧊","🌵","🦴","🔮","🎲","🪐","🐸","🚀"],
        equations: [
          { left:["🧊","+","🌵"], target:8 },                     //6+2
          { left:["🦴","+","🔮"], target:14 },                   //5+9
          { left:["🌵","+","🎲"], target:6 },                    //2+4
          { left:["🪐","+","🐸"], target:15 },                   //7+8
          { left:["🎲","+","🐙"], target:5 },                    //4+1
          { left:["🐙","+","🦴","+","🔮","+","🚀"], target:18 }   //1+5+9+3
        ]
      },

      // 9. BY DOG I MEAN SON
      {
        phrase: "BY DOG I MEAN SON",
        phraseWords: [
          ["🧊","🎲"],               // BY
          ["🐸","🪐","🦊"],          // DOG
          ["🍄"],                    // I
          ["🚀","🌵","🪼","🔮"],     // MEAN
          ["🐙","🪐","🔮"]           // SON
        ],
        // We need B Y / D O G / I / M E A N / S O N
        mapping: {
          "🧊": { letter:"B", number:4 },
          "🎲": { letter:"Y", number:7 },
          "🐸": { letter:"D", number:8 },
          "🪐": { letter:"O", number:6 },
          "🦊": { letter:"G", number:5 },
          "🍄": { letter:"I", number:3 },
          "🚀": { letter:"M", number:9 },
          "🌵": { letter:"E", number:2 },
          "🪼": { letter:"A", number:1 },
          "🔮": { letter:"N", number:4 },
          "🐙": { letter:"S", number:6 }
        },
        uniqueEmojis: ["🧊","🎲","🐸","🪐","🦊","🍄","🚀","🌵","🪼","🔮","🐙"],
        equations: [
          { left:["🧊","+","🎲"], target:11 },           //4+7
          { left:["🐸","+","🪐"], target:14 },           //8+6
          { left:["🦊","+","🍄"], target:8 },            //5+3
          { left:["🚀","+","🌵"], target:11 },           //9+2
          { left:["🪼","+","🔮"], target:5 },            //1+4
          { left:["🐙","+","🪐","+","🔮"], target:16 }    //6+6+4
        ]
      },

      // 10. GREAT WORK SO FAR
      {
        phrase: "GREAT WORK SO FAR",
        phraseWords: [
          ["🦊","🌵","🧊","🎲","🔮"],  // GREAT
          ["🚀","🐸","🌵","🦴"],       // WORK
          ["🐙","🐸"],                // SO
          ["🍄","🎲","🌵"]            // FAR
        ],
        // We need G R E A T / W O R K / S O / F A R
        mapping: {
          "🦊": { letter:"G", number:8 },
          "🌵": { letter:"R", number:4 },
          "🧊": { letter:"E", number:2 },
          "🎲": { letter:"A", number:1 },
          "🔮": { letter:"T", number:9 },
          "🚀": { letter:"W", number:6 },
          "🐸": { letter:"O", number:7 },
          "🦴": { letter:"K", number:5 },
          "🐙": { letter:"S", number:3 },
          "🍄": { letter:"F", number:4 }
        },
        uniqueEmojis: ["🦊","🌵","🧊","🎲","🔮","🚀","🐸","🦴","🐙","🍄"],
        equations: [
          { left:["🦊","+","🌵"], target:12 },         //8+4
          { left:["🧊","+","🎲"], target:3 },          //2+1
          { left:["🔮","+","🚀"], target:15 },         //9+6
          { left:["🐸","+","🌵"], target:11 },         //7+4
          { left:["🦴","+","🐙"], target:8 },          //5+3
          { left:["🍄","+","🎲","+","🌵"], target:9 }   //4+1+4
        ]
      }
    ];

    // Pick a random puzzle on load
    const currentPuzzle = PUZZLES[Math.floor(Math.random() * PUZZLES.length)];

    // Track solve state for each emoji
    // { "🦊": {letter:"", number:"", solved:false}, ... }
    const playerState = {};
    currentPuzzle.uniqueEmojis.forEach(em=>{
      playerState[em] = { letter:"", number:"", solved:false };
    });

    // DOM refs
    const phraseArea    = document.getElementById("phraseArea");
    const equationsArea = document.getElementById("equationsArea");
    const solutionLines = document.getElementById("solutionLines");
    const winBox        = document.getElementById("winBox");

    // Render PHRASE
    // Each word:
    // - top row: inputs per emoji
    // - bottom row: emojis per emoji
    // After each word (except last), insert a "/" separator visually in the wrapper.
    function renderPhrase(){
      phraseArea.innerHTML = "";

      currentPuzzle.phraseWords.forEach((wordArr, wordIdx)=>{
        const wordBlock = document.createElement("div");
        wordBlock.className = "word-block";

        const topRow = document.createElement("div");
        topRow.className = "word-top-row";

        wordArr.forEach((em, charIdx)=>{
          const stack = document.createElement("div");
          stack.className = "char-stack";
          stack.dataset.emoji = em;
          stack.dataset.wordIndex = wordIdx;
          stack.dataset.charIndex = charIdx;

          const inp = document.createElement("input");
          inp.className = "char-input";
          inp.maxLength = 1;
          inp.placeholder = "_";
          inp.dataset.emoji = em;
          inp.dataset.kind = "letter";
          inp.addEventListener("input", handleGuessInput);

          const emDiv = document.createElement("div");
          emDiv.className = "char-emoji";
          emDiv.textContent = em;

          stack.appendChild(inp);
          stack.appendChild(emDiv);
          topRow.appendChild(stack);
        });

        // emoji row under it (visual reference)
        wordArr.forEach(em=>{
          const emSpan = document.createElement("div");
          emSpan.className = "char-emoji";
          emSpan.textContent = em;
        });

        wordBlock.appendChild(topRow);
        phraseArea.appendChild(wordBlock);

        if (wordIdx < currentPuzzle.phraseWords.length - 1){
          const slash = document.createElement("div");
          slash.className = "word-separator";
          slash.textContent = "/";
          phraseArea.appendChild(slash);
        }
      });
    }

    // Render EQUATIONS
    // Each equation is:
    // [ num-input / emoji ] + [ num-input / emoji ] ... = target ✅/❌
    function renderEquations(){
      equationsArea.innerHTML = "";

      currentPuzzle.equations.forEach((eqObj, eqIndex)=>{
        const row = document.createElement("div");
        row.className = "equation-row";

        const leftWrap = document.createElement("div");
        leftWrap.className = "eq-left";

        eqObj.left.forEach(token=>{
          if(token === "+"){
            const plus = document.createElement("div");
            plus.className = "eq-op";
            plus.textContent = "+";
            leftWrap.appendChild(plus);
          } else {
            const stack = document.createElement("div");
            stack.className = "eq-stack";
            stack.dataset.emoji = token;
            stack.dataset.eqIndex = eqIndex;

            const numInp = document.createElement("input");
            numInp.className = "num-input";
            numInp.maxLength = 1;
            numInp.placeholder = "_";
            numInp.dataset.emoji = token;
            numInp.dataset.kind = "number";
            numInp.addEventListener("input", handleGuessInput);

            const emDiv = document.createElement("div");
            emDiv.className = "char-emoji";
            emDiv.textContent = token;

            stack.appendChild(numInp);
            stack.appendChild(emDiv);
            leftWrap.appendChild(stack);
          }
        });

        const eqTarget = document.createElement("div");
        eqTarget.className = "eq-target";
        eqTarget.textContent = "= " + eqObj.target;

        const eqRes = document.createElement("div");
        eqRes.className = "eq-result status-bad";
        eqRes.dataset.eqIndex = eqIndex;
        eqRes.textContent = "❌";

        row.appendChild(leftWrap);
        row.appendChild(eqTarget);
        row.appendChild(eqRes);
        equationsArea.appendChild(row);
      });

      updateEquationsStatus();
    }

    // Render SOLUTION KEY
    // For each solved emoji, show "🦊 = C = 3"
    function renderSolutionBox(){
      solutionLines.innerHTML = "";
      currentPuzzle.uniqueEmojis.forEach(em=>{
        const st = playerState[em];
        if(st.solved){
          const line = document.createElement("div");
          line.className = "solution-line-solved";
          line.textContent = `${em} = ${st.letter} = ${st.number}`;
          solutionLines.appendChild(line);
        }
      });
    }

    // Handle guesses from any input:
    // - phrase letter boxes (kind="letter")
    // - equation number boxes (kind="number")
    function handleGuessInput(e){
      const em   = e.target.dataset.emoji;
      const kind = e.target.dataset.kind;

      // if it's already solved, just sync it back and ignore edits
      if(playerState[em].solved){
        syncSolvedEmojiEverywhere(em);
        updateEquationsStatus();
        checkWin();
        return;
      }

      let val = e.target.value;

      if(kind === "letter"){
        val = val.toUpperCase().replace(/[^A-Z]/g,"").slice(0,1);
        e.target.value = val;
      } else {
        // kind === "number"
        if(val !== ""){
          let n = parseInt(val,10);
          if(isNaN(n)) n = "";
          if(n < 0) n = 0;
          if(n > 9) n = 9;
          e.target.value = n === "" ? "" : String(n);
          val = e.target.value;
        }
      }

      const correctLetter = currentPuzzle.mapping[em].letter;
      const correctNumber = String(currentPuzzle.mapping[em].number);

      const solvedByLetter = (kind==="letter" && val === correctLetter);
      const solvedByNumber = (kind==="number" && val === correctNumber);

      if(solvedByLetter || solvedByNumber){
        // Mark global solved
        playerState[em].solved  = true;
        playerState[em].letter  = correctLetter;
        playerState[em].number  = correctNumber;

        syncSolvedEmojiEverywhere(em);
      } else {
        // Not solved yet, store partial guess
        if(kind === "letter"){
          playerState[em].letter = val;
        } else {
          playerState[em].number = val;
        }
      }

      updateEquationsStatus();
      renderSolutionBox();
      checkWin();
    }

    // Sync an emoji everywhere once it's solved:
    // - fill and disable all phrase letter inputs for that emoji
    // - fill and disable all number inputs for that emoji in equations
    // - update solution box
    function syncSolvedEmojiEverywhere(em){
      const correctLetter = currentPuzzle.mapping[em].letter;
      const correctNumber = String(currentPuzzle.mapping[em].number);
      playerState[em].solved  = true;
      playerState[em].letter  = correctLetter;
      playerState[em].number  = correctNumber;

      // phrase inputs
      const phraseInputs = phraseArea.querySelectorAll(`.char-input[data-emoji="${em}"]`);
      phraseInputs.forEach(inp=>{
        inp.value = correctLetter;
        inp.disabled = true;
      });

      // equation inputs
      const eqInputs = equationsArea.querySelectorAll(`.num-input[data-emoji="${em}"]`);
      eqInputs.forEach(inp=>{
        inp.value = correctNumber;
        inp.disabled = true;
      });

      renderSolutionBox();
    }

    // Check equations to set ✅ / ❌
    function updateEquationsStatus(){
      currentPuzzle.equations.forEach((eqObj, eqIndex)=>{
        let allKnown = true;
        let total = 0;

        eqObj.left.forEach(token=>{
          if(token === "+") return;
          if(playerState[token].solved){
            total += currentPuzzle.mapping[token].number;
          } else {
            allKnown = false;
          }
        });

        const resDiv = equationsArea.querySelector(`.eq-result[data-eq-index="${eqIndex}"]`);
        if(!resDiv) return;
        if(allKnown && total === eqObj.target){
          resDiv.textContent = "✅";
          resDiv.classList.remove("status-bad");
          resDiv.classList.add("status-ok");
        } else {
          resDiv.textContent = "❌";
          resDiv.classList.remove("status-ok");
          resDiv.classList.add("status-bad");
        }
      });
    }

    // Build the solved phrase so far:
    // For win check, we ONLY accept correct solved emojis.
    // Unsolved positions count as "_".
    function getCurrentSolvedPhrase(){
      const wordsSolved = currentPuzzle.phraseWords.map(wordArr => {
        return wordArr.map(em => {
          if(playerState[em].solved){
            return currentPuzzle.mapping[em].letter;
          } else {
            return "_";
          }
        }).join("");
      });
      return wordsSolved.join(" ");
    }

    // Check win:
    // - phrase must be fully revealed AND match puzzle.phrase
    // - all equations must show ✅
    function checkWin(){
      const finalPhrase = getCurrentSolvedPhrase();
      const phraseDone = (finalPhrase === currentPuzzle.phrase);

      let allEqCorrect = true;
      currentPuzzle.equations.forEach((eqObj, eqIndex)=>{
        const resDiv = equationsArea.querySelector(`.eq-result[data-eq-index="${eqIndex}"]`);
        if(!resDiv || !resDiv.classList.contains("status-ok")){
          allEqCorrect = false;
        }
      });

      if(phraseDone && allEqCorrect){
        winBox.style.display = "block";
      } else {
        winBox.style.display = "none";
      }
    }

    // Init
    function init(){
      renderPhrase();
      renderEquations();
      renderSolutionBox(); // starts empty
    }

    init();

  })();
  </script>
</body>
</html>
