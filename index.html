<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emoji Cipher™ – A New Puzzle!</title>
  <meta name="description" content="Emoji Cipher™ is an original logic puzzle by Salimah Ismail. Decode the emojis to reveal the hidden phrase and balance the equations.">
  <meta name="author" content="Salimah Ismail">
  <meta name="copyright" content="© 2025 Salimah Ismail. Licensed under CC BY-NC-ND 4.0 International.">
  <meta name="license" content="https://creativecommons.org/licenses/by-nc-nd/4.0/">
  <style>
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
      margin: 2rem auto;
      max-width: 680px;
      line-height: 1.5;
      color: #222;
      background: #fdfdfd;
    }
    h1, h2 { text-align: center; }

    h1 {
  color: #8C6737; /* pick your color here */
}
h2 {
  color: #36171D; /* match, or choose a different accent */
  font-weight: 500;
}


    .note-box {
      background: #F6EAED;
      border: 1px solid #36171D;
      border-radius: .5rem;
      padding: .75rem;
      margin-bottom: 1rem;
      font-size: .9rem;
    }

    .section-title{
      font-size:1rem;
      font-weight:600;
      margin:1.5rem 0 .5rem;
      text-transform:uppercase;
      letter-spacing:.03em;
      color:#8C6737;
    }

    /* Phrase layout */
    .phrase-wrapper {
      background:#fff;
      border:1px solid #ddd;
      border-radius:.5rem;
      padding:1rem;
      box-shadow:0 1px 2px rgb(0 0 0 / .05);
      display:flex;
      flex-wrap:wrap;
      row-gap:1rem;
      column-gap:1rem;
      font-size:1.1rem;
    }

    .word-block {
      display:flex;
      flex-direction:column;
      align-items:flex-start;
    }

    .word-top-row {
      display:flex;
      align-items:flex-start;
      gap:.6rem;
      flex-wrap:nowrap;
    }

    .char-stack {
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:2.4rem;
    }

    .char-input {
      width:2.4rem;
      height:2.4rem;
      font-size:1.1rem;
      text-align:center;
      font-weight:600;
      border:1.5px solid #bbb;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / 0.05);
      font-family:inherit;
    }
    .char-input::placeholder {
      color:#999;
      font-weight:400;
    }
    .char-input:focus{
      outline:none;
      border-color:#000;
    }
    .char-input[disabled]{
      background:#e6ffe6;
      border-color:#108a00;
      color:#0a4f00;
      font-weight:600;
    }

    .char-emoji {
      font-size:1.4rem;
      line-height:1.2;
      margin-top:.25rem;
    }

    .word-separator {
      font-weight:600;
      font-size:1rem;
      line-height:1;
      color:#666;
      margin-left:.5rem;
    }

    /* Equations block */
    .equations-wrapper{
      border:1px solid #ddd;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / .05);
      padding:.75rem 1rem;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:.9rem;
    }

    .equation-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:.75rem 1rem;
      padding:.75rem 0;
      border-bottom:1px solid #eee;
    }
    .equation-row:last-child{border-bottom:none;}

    .eq-left {
      display:flex;
      flex-wrap:wrap;
      gap:.75rem;
      align-items:flex-end;
    }

    .eq-stack {
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:2.4rem;
    }

    .num-input {
      width:2.4rem;
      height:2.4rem;
      font-size:1rem;
      text-align:center;
      font-weight:600;
      border:1.5px solid #bbb;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / 0.05);
      font-family:inherit;
    }
    .num-input::placeholder{
      color:#999;
      font-weight:400;
    }
    .num-input:focus{
      outline:none;
      border-color:#000;
    }
    .num-input[disabled]{
      background:#e6ffe6;
      border-color:#108a00;
      color:#0a4f00;
      font-weight:600;
    }

    .eq-op {
      font-size:1.1rem;
      font-weight:600;
      line-height:1;
      align-self:center;
    }

    .eq-target {
      font-weight:600;
    }

    .eq-result {
      font-weight:600;
      min-width:2rem;
      text-align:center;
    }
    .status-ok{color:#108a00;}
    .status-bad{color:#b00020;}

    /* Solution key styling (currently hidden in HTML, but CSS can stay) */
    .solution-box {
      border:1px solid #ddd;
      border-radius:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgb(0 0 0 / .05);
      padding:1rem;
      font-size:.95rem;
      line-height:1.4;
      color:#222;
      white-space:pre-line;
    }
    .solution-line-solved {
      background:#e6ffe6;
      border-left:3px solid #108a00;
      padding:.25rem .5rem;
      border-radius:.25rem;
      margin-bottom:.5rem;
      font-weight:600;
      color:#0a4f00;
      box-shadow:0 1px 2px rgb(0 0 0 / .06) inset;
    }
    .solution-hint {
      font-size:.8rem;
      color:#666;
      margin-bottom:.5rem;
    }

    .win-box{
      margin-top:1rem;
      border-radius:.75rem;
      padding:1rem;
      font-weight:600;
      text-align:center;
      font-size:1rem;
      display:none;
      background:#e6ffe6;
      border:2px solid #108a00;
      color:#0a4f00;
      box-shadow:0 4px 10px rgb(0 0 0 / .08);
    }

    footer{
      margin-top:2rem;
      font-size:.8rem;
      text-align:center;
      color:#666;
    }
    footer a{
      color:#555;
      text-decoration:none;
    }

    /* celebration confetti canvas */
#confettiCanvas {
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 999999; /* keep it above the puzzle */
}

    /* full-screen win text */
#solvedMessage {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size: 6vw;
  font-weight: 800;
  color: white;
  text-shadow: 0 0 25px rgba(0,0,0,0.6);
  opacity: 0;
  z-index: 1000000;
  pointer-events: none;
  transition:
    opacity 0.4s ease,
    transform 0.4s ease;
}
#solvedMessage.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}


  </style>
</head>
<body>
  <h1>Emoji Cipher™</h1>
  <h2>A New Puzzle Game by <a href="https://salimahismail.com">Salimah!</a></h2>

  <div class="note-box">
    Each emoji hides a secret <b>LETTER</b> and <b>NUMBER</b>.<br>
    Every letter is unique, <i>but numbers can repeat.</i> <br>
    Unlock one and you'll get the other. <br>
    Good Luck!
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; gap:.5rem;">
    <button id="prevBtn" style="flex:1; padding:.75rem 1rem; font-size:1rem; border-radius:.5rem; border:1px solid #999; background:#fff; cursor:pointer;">
      ◀ Previous
    </button>
    <div id="puzzleLabel" style="flex:0; font-size:.9rem; font-weight:600; color:#555; text-align:center; white-space:nowrap;">
      Puzzle 1 / 10
    </div>
    <button id="nextBtn" style="flex:1; padding:.75rem 1rem; font-size:1rem; border-radius:.5rem; border:1px solid #999; background:#fff; cursor:pointer;">
      Next ▶
    </button>
  </div>

  <div style="text-align:center; margin-top:.5rem;">
  <button id="testConfettiBtn" style="padding:.5rem .75rem; font-size:.8rem; border-radius:.5rem; border:1px solid #aaa; background:#fff; cursor:pointer;">
    🎉 Test Confetti
  </button>
</div>

  <div class="section-title">Decode the Phrase</div>
  <div class="phrase-wrapper" id="phraseArea"></div>

  <div class="section-title">Crack the Math</div>
  <div class="equations-wrapper" id="equationsArea"></div>

  <!--
  <div class="section-title">Solution Key (auto-fills as you solve)</div>
  <div class="solution-box" id="solutionBox">
    <div class="solution-hint">Solve any letter or number to unlock its pair:</div>
    <div id="solutionLines"></div>
  </div>

  <div class="win-box" id="winBox">
    ✅ You solved it!
  </div>
  -->

  <footer>
    Emoji Cipher™ © 2025 Salimah Ismail.<br>
    Licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0 International</a>. <br>
    <a href="https://salimahismail.com" target="_blank">https://salimahismail.com</a> 
  </footer>

  <canvas id="confettiCanvas"></canvas>

  <div id="solvedMessage">YOU SOLVED IT!</div>

  <script>
  (function(){

    // -----------------------
    // 1. PUZZLES
    // -----------------------
    const PUZZLES = [
      // 1. COOL GAME BRO
      {
        phrase: "COOL GAME BRO",
        phraseWords: [
          ["🦊","🪐","🪐","🐸"],        // COOL
          ["🚀","🌵","🎲","🔮"],        // GAME
          ["🧊","🐙","🪐"]             // BRO
        ],
        mapping: {
          "🦊": { letter:"C", number:3 },
          "🪐": { letter:"O", number:8 },
          "🐸": { letter:"L", number:4 },
          "🚀": { letter:"G", number:7 },
          "🌵": { letter:"A", number:1 },
          "🎲": { letter:"M", number:6 },
          "🔮": { letter:"E", number:2 },
          "🧊": { letter:"B", number:5 },
          "🐙": { letter:"R", number:9 }
        },
        uniqueEmojis: ["🦊","🪐","🐸","🚀","🌵","🎲","🔮","🧊","🐙"],
        equations: [
          { left:["🦊","+","🪐"], target:11 },
          { left:["🪐","+","🐸"], target:12 },
          { left:["🚀","+","🌵","+","🎲"], target:14 },
          { left:["🎲","+","🔮"], target:8 },
          { left:["🧊","+","🌵"], target:6 },
          { left:["🐙","+","🌵"], target:10 }
        ]
      },

      // 2. IT IS NAP TIME
      {
        phrase: "IT IS NAP TIME",
        phraseWords: [
          ["🍄","🧊"],                // IT
          ["🍄","🐸"],                // IS
          ["🐙","🌵","🦊"],           // NAP
          ["🧊","🍄","🎲","🔮"]       // TIME
        ],
        mapping: {
          "🍄": { letter:"I", number:4 },
          "🧊": { letter:"T", number:9 },
          "🐸": { letter:"S", number:2 },
          "🐙": { letter:"N", number:5 },
          "🌵": { letter:"A", number:1 },
          "🦊": { letter:"P", number:7 },
          "🎲": { letter:"M", number:6 },
          "🔮": { letter:"E", number:3 }
        },
        uniqueEmojis: ["🍄","🧊","🐸","🐙","🌵","🦊","🎲","🔮"],
        equations: [
          { left:["🍄","+","🧊"], target:13 },
          { left:["🐸","+","🐙"], target:7 },
          { left:["🌵","+","🦊"], target:8 },
          { left:["🎲","+","🔮"], target:9 },
          { left:["🧊","+","🎲"], target:15 }
        ]
      },

      // 3. HERBAL OR VERBAL TEA
      {
        phrase: "HERBAL OR VERBAL TEA",
        phraseWords: [
          ["🪐","🔮","🌊","🚀","🌵","🐙"],   // HERBAL
          ["🎲","🌊"],                    // OR
          ["🦊","🔮","🌊","🚀","🌵","🐙"],  // VERBAL
          ["🧊","🔮","🌵"]                // TEA
        ],
        mapping: {
          "🪐": { letter:"H", number:4 },
          "🔮": { letter:"E", number:2 },
          "🌊": { letter:"R", number:9 },
          "🚀": { letter:"B", number:5 },
          "🌵": { letter:"A", number:1 },
          "🐙": { letter:"L", number:7 },
          "🎲": { letter:"O", number:6 },
          "🦊": { letter:"V", number:8 },
          "🧊": { letter:"T", number:3 }
        },
        uniqueEmojis: ["🪐","🔮","🌊","🚀","🌵","🐙","🎲","🦊","🧊"],
        equations: [
          { left:["🪐","+","🔮"], target:6 },
          { left:["🌊","+","🚀"], target:14 },
          { left:["🌵","+","🐙"], target:8 },
          { left:["🎲","+","🌊"], target:15 },
          { left:["🦊","+","🔮"], target:10 },
          { left:["🧊","+","🔮","+","🌵"], target:6 }
        ]
      },

      // 4. ADDICTED TO RAGEAHOL
      {
        phrase: "ADDICTED TO RAGEAHOL",
        phraseWords: [
          ["🌵","🎲","🎲","🍄","🦊","🧊","🔮","🎲"], // ADDICTED
          ["🧊","🎲"],                             // TO
          ["🌊","🌵","🚀","🔮","🌵","🐸","🎲","🐙"]  // RAGEAHOL
        ],
        mapping: {
          "🌵": { letter:"A", number:1 },
          "🎲": { letter:"D", number:7 },
          "🍄": { letter:"I", number:4 },
          "🦊": { letter:"C", number:8 },
          "🧊": { letter:"T", number:9 },
          "🔮": { letter:"E", number:3 },
          "🌊": { letter:"R", number:5 },
          "🚀": { letter:"G", number:2 },
          "🐸": { letter:"H", number:4 },
          "🐙": { letter:"L", number:8 }
        },
        uniqueEmojis: ["🌵","🎲","🍄","🦊","🧊","🔮","🌊","🚀","🐸","🐙"],
        equations: [
          { left:["🌵","+","🎲"], target:8 },
          { left:["🎲","+","🍄"], target:11 },
          { left:["🦊","+","🧊"], target:17 },
          { left:["🔮","+","🎲"], target:10 },
          { left:["🌊","+","🌵","+","🚀"], target:8 },
          { left:["🐸","+","🎲"], target:11 },
          { left:["🎲","+","🐙"], target:15 }
        ]
      },

      // 5. I BARELY EVEN KNOW HER (FIXED)
      {
        phrase: "I BARELY EVEN KNOW HER",
        phraseWords: [
          ["🍄"],                                         // I
          ["🚀","🌵","🌊","🔮","🐙","🧊"],                 // BARELY
          ["🔮","🎲","🔮","🪐"],                           // EVEN
          ["🦊","🪐","🐸","🦴"],                           // KNOW
          ["🐢","🔮","🌊"]                                // HER
        ],
        mapping: {
          "🍄": { letter:"I", number:4 },
          "🚀": { letter:"B", number:6 },
          "🌵": { letter:"A", number:1 },
          "🌊": { letter:"R", number:9 },
          "🔮": { letter:"E", number:2 },
          "🐙": { letter:"L", number:7 },
          "🧊": { letter:"Y", number:8 },
          "🎲": { letter:"V", number:5 },
          "🪐": { letter:"N", number:3 },
          "🦊": { letter:"K", number:4 },
          "🐸": { letter:"O", number:6 },
          "🦴": { letter:"W", number:2 },
          "🐢": { letter:"H", number:5 }
        },
        uniqueEmojis: ["🍄","🚀","🌵","🌊","🔮","🐙","🧊","🎲","🪐","🦊","🐸","🦴","🐢"],
        equations: [
          { left:["🍄","+","🚀"], target:10 },
          { left:["🌵","+","🌊"], target:10 },
          { left:["🔮","+","🐙","+","🧊"], target:17 },
          { left:["🔮","+","🎲"], target:7 },
          { left:["🦊","+","🪐","+","🐸","+","🦴"], target:15 },
          { left:["🐢","+","🔮"], target:7 }
        ]
      },

      // 6. SEND MORE KITTENS
      {
        phrase: "SEND MORE KITTENS",
        phraseWords: [
          ["🦊","🐸","🪐","🎲"],               // SEND
          ["🚀","🔮","🌵","🐸"],               // MORE
          ["🧊","🍄","🦴","🦴","🐸","🪼","🐍"] // KITTENS
        ],
        mapping: {
          "🦊": { letter:"S", number:6 },
          "🐸": { letter:"E", number:2 },
          "🪐": { letter:"N", number:5 },
          "🎲": { letter:"D", number:4 },
          "🚀": { letter:"M", number:7 },
          "🔮": { letter:"O", number:8 },
          "🌵": { letter:"R", number:3 },
          "🧊": { letter:"K", number:9 },
          "🍄": { letter:"I", number:1 },
          "🦴": { letter:"T", number:4 },
          "🪼": { letter:"N", number:5 },
          "🐍": { letter:"S", number:6 }
        },
        uniqueEmojis: ["🦊","🐸","🪐","🎲","🚀","🔮","🌵","🧊","🍄","🦴","🪼","🐍"],
        equations: [
          { left:["🦊","+","🐸"], target:8 },
          { left:["🐸","+","🪐","+","🎲"], target:11 },
          { left:["🚀","+","🔮"], target:15 },
          { left:["🌵","+","🐸"], target:5 },
          { left:["🧊","+","🍄"], target:10 },
          { left:["🦴","+","🦴"], target:8 },
          { left:["🐸","+","🪼","+","🐍"], target:13 }
        ]
      },

      // 7. CAUGHT A VIBE
      {
        phrase: "CAUGHT A VIBE",
        phraseWords: [
          ["🌵","🐙","🚀","🦊","🐸","🧊"], // CAUGHT
          ["🐙"],                        // A
          ["🎲","🔮","🪐","🦴"]          // VIBE
        ],
        mapping: {
          "🌵": { letter:"C", number:2 },
          "🐙": { letter:"A", number:1 },
          "🚀": { letter:"U", number:6 },
          "🦊": { letter:"G", number:7 },
          "🐸": { letter:"H", number:4 },
          "🧊": { letter:"T", number:9 },
          "🎲": { letter:"V", number:8 },
          "🔮": { letter:"I", number:3 },
          "🪐": { letter:"B", number:5 },
          "🦴": { letter:"E", number:2 }
        },
        uniqueEmojis: ["🌵","🐙","🚀","🦊","🐸","🧊","🎲","🔮","🪐","🦴"],
        equations: [
          { left:["🌵","+","🐙"], target:3 },
          { left:["🚀","+","🦊"], target:13 },
          { left:["🐸","+","🧊"], target:13 },
          { left:["🎲","+","🔮"], target:11 },
          { left:["🪐","+","🦴"], target:7 },
          { left:["🐙","+","🎲"], target:9 }
        ]
      },

      // 8. A CENTER FOR ANTS
      {
        phrase: "A CENTER FOR ANTS",
        phraseWords: [
          ["🐙"],                                  // A
          ["🧊","🌵","🦴","🔮","🌵","🎲"],          // CENTER
          ["🪐","🐸","🎲"],                         // FOR
          ["🐙","🦴","🔮","🚀"]                     // ANTS
        ],
        mapping: {
          "🐙": { letter:"A", number:1 },
          "🧊": { letter:"C", number:6 },
          "🌵": { letter:"E", number:2 },
          "🦴": { letter:"N", number:5 },
          "🔮": { letter:"T", number:9 },
          "🎲": { letter:"R", number:4 },
          "🪐": { letter:"F", number:7 },
          "🐸": { letter:"O", number:8 },
          "🚀": { letter:"S", number:3 }
        },
        uniqueEmojis: ["🐙","🧊","🌵","🦴","🔮","🎲","🪐","🐸","🚀"],
        equations: [
          { left:["🧊","+","🌵"], target:8 },
          { left:["🦴","+","🔮"], target:14 },
          { left:["🌵","+","🎲"], target:6 },
          { left:["🪐","+","🐸"], target:15 },
          { left:["🎲","+","🐙"], target:5 },
          { left:["🐙","+","🦴","+","🔮","+","🚀"], target:18 }
        ]
      },

      // 9. BY DOG I MEAN SON
      {
        phrase: "BY DOG I MEAN SON",
        phraseWords: [
          ["🧊","🎲"],               // BY
          ["🐸","🪐","🦊"],          // DOG
          ["🍄"],                    // I
          ["🚀","🌵","🪼","🔮"],     // MEAN
          ["🐙","🪐","🔮"]           // SON
        ],
        mapping: {
          "🧊": { letter:"B", number:4 },
          "🎲": { letter:"Y", number:7 },
          "🐸": { letter:"D", number:8 },
          "🪐": { letter:"O", number:6 },
          "🦊": { letter:"G", number:5 },
          "🍄": { letter:"I", number:3 },
          "🚀": { letter:"M", number:9 },
          "🌵": { letter:"E", number:2 },
          "🪼": { letter:"A", number:1 },
          "🔮": { letter:"N", number:4 },
          "🐙": { letter:"S", number:6 }
        },
        uniqueEmojis: ["🧊","🎲","🐸","🪐","🦊","🍄","🚀","🌵","🪼","🔮","🐙"],
        equations: [
          { left:["🧊","+","🎲"], target:11 },
          { left:["🐸","+","🪐"], target:14 },
          { left:["🦊","+","🍄"], target:8 },
          { left:["🚀","+","🌵"], target:11 },
          { left:["🪼","+","🔮"], target:5 },
          { left:["🐙","+","🪐","+","🔮"], target:16 }
        ]
      },

      // 10. GREAT WORK SO FAR
      {
        phrase: "GREAT WORK SO FAR",
        phraseWords: [
          ["🦊","🌵","🧊","🎲","🔮"],  // GREAT
          ["🚀","🐸","🌵","🦴"],       // WORK
          ["🐙","🐸"],                // SO
          ["🍄","🎲","🌵"]            // FAR
        ],
        mapping: {
          "🦊": { letter:"G", number:8 },
          "🌵": { letter:"R", number:4 },
          "🧊": { letter:"E", number:2 },
          "🎲": { letter:"A", number:1 },
          "🔮": { letter:"T", number:9 },
          "🚀": { letter:"W", number:6 },
          "🐸": { letter:"O", number:7 },
          "🦴": { letter:"K", number:5 },
          "🐙": { letter:"S", number:3 },
          "🍄": { letter:"F", number:4 }
        },
        uniqueEmojis: ["🦊","🌵","🧊","🎲","🔮","🚀","🐸","🦴","🐙","🍄"],
        equations: [
          { left:["🦊","+","🌵"], target:12 },
          { left:["🧊","+","🎲"], target:3 },
          { left:["🔮","+","🚀"], target:15 },
          { left:["🐸","+","🌵"], target:11 },
          { left:["🦴","+","🐙"], target:8 },
          { left:["🍄","+","🎲","+","🌵"], target:9 }
        ]
      }
    ];

    // -----------------------
    // 2. GLOBAL STATE
    // -----------------------
    let currentIndex = 0;
    let currentPuzzle = PUZZLES[currentIndex];

    // per-emoji solve state for current puzzle
    const playerState = {};
    currentPuzzle.uniqueEmojis.forEach(em=>{
      playerState[em] = { letter:"", number:"", solved:false };
    });

    // confetti state
    let hasCelebrated = false;

    // -----------------------
    // 3. DOM REFS
    // -----------------------
    const phraseArea    = document.getElementById("phraseArea");
    const equationsArea = document.getElementById("equationsArea");
    const solutionLines = document.getElementById("solutionLines"); // may be null (hidden box)
    const winBox        = document.getElementById("winBox");        // may be null (hidden box)
    const prevBtn       = document.getElementById("prevBtn");
    const nextBtn       = document.getElementById("nextBtn");
    const puzzleLabel   = document.getElementById("puzzleLabel");

    // -----------------------
    // 4. RENDER PHRASE
    // -----------------------
    function renderPhrase(){
      phraseArea.innerHTML = "";

      currentPuzzle.phraseWords.forEach((wordArr, wordIdx)=>{
        const wordBlock = document.createElement("div");
        wordBlock.className = "word-block";

        const topRow = document.createElement("div");
        topRow.className = "word-top-row";

        wordArr.forEach((em, charIdx)=>{
          const stack = document.createElement("div");
          stack.className = "char-stack";
          stack.dataset.emoji = em;
          stack.dataset.wordIndex = wordIdx;
          stack.dataset.charIndex = charIdx;

          const inp = document.createElement("input");
          inp.className = "char-input";
          inp.maxLength = 1;
          inp.placeholder = "_";
          inp.dataset.emoji = em;
          inp.dataset.kind = "letter";
          inp.addEventListener("input", handleGuessInput);

          const emDiv = document.createElement("div");
          emDiv.className = "char-emoji";
          emDiv.textContent = em;

          stack.appendChild(inp);
          stack.appendChild(emDiv);
          topRow.appendChild(stack);
        });

        wordBlock.appendChild(topRow);
        phraseArea.appendChild(wordBlock);

        if (wordIdx < currentPuzzle.phraseWords.length - 1){
          const slash = document.createElement("div");
          slash.className = "word-separator";
          slash.textContent = "/";
          phraseArea.appendChild(slash);
        }
      });
    }

    // -----------------------
    // 5. RENDER EQUATIONS
    // -----------------------
    function renderEquations(){
      equationsArea.innerHTML = "";

      currentPuzzle.equations.forEach((eqObj, eqIndex)=>{
        const row = document.createElement("div");
        row.className = "equation-row";

        const leftWrap = document.createElement("div");
        leftWrap.className = "eq-left";

        eqObj.left.forEach(token=>{
          if(token === "+"){
            const plus = document.createElement("div");
            plus.className = "eq-op";
            plus.textContent = "+";
            leftWrap.appendChild(plus);
          } else {
            const stack = document.createElement("div");
            stack.className = "eq-stack";
            stack.dataset.emoji = token;
            stack.dataset.eqIndex = eqIndex;

            const numInp = document.createElement("input");
            numInp.className = "num-input";
            numInp.maxLength = 1;
            numInp.placeholder = "_";
            numInp.dataset.emoji = token;
            numInp.dataset.kind = "number";
            numInp.addEventListener("input", handleGuessInput);

            const emDiv = document.createElement("div");
            emDiv.className = "char-emoji";
            emDiv.textContent = token;

            stack.appendChild(numInp);
            stack.appendChild(emDiv);
            leftWrap.appendChild(stack);
          }
        });

        const eqTarget = document.createElement("div");
        eqTarget.className = "eq-target";
        eqTarget.textContent = "= " + eqObj.target;

        const eqRes = document.createElement("div");
        eqRes.className = "eq-result status-bad";
        eqRes.dataset.eqIndex = eqIndex;
        eqRes.textContent = "❌";

        row.appendChild(leftWrap);
        row.appendChild(eqTarget);
        row.appendChild(eqRes);
        equationsArea.appendChild(row);
      });

      updateEquationsStatus();
    }

    // -----------------------
    // 6. SOLUTION KEY (hidden UI-safe)
    // -----------------------
    function renderSolutionBox(){
      if (!solutionLines) return;
      solutionLines.innerHTML = "";
      currentPuzzle.uniqueEmojis.forEach(em=>{
        const st = playerState[em];
        if(st.solved){
          const line = document.createElement("div");
          line.className = "solution-line-solved";
          line.textContent = `${em} = ${st.letter} = ${st.number}`;
          solutionLines.appendChild(line);
        }
      });
    }

    // -----------------------
    // 7. EQUATIONS STATUS
    // -----------------------
    function updateEquationsStatus(){
      currentPuzzle.equations.forEach((eqObj, eqIndex)=>{
        let allKnown = true;
        let total = 0;

        eqObj.left.forEach(token=>{
          if(token === "+") return;
          if(playerState[token].solved){
            total += currentPuzzle.mapping[token].number;
          } else {
            allKnown = false;
          }
        });

        const resDiv = equationsArea.querySelector(`.eq-result[data-eq-index="${eqIndex}"]`);
        if(!resDiv) return;
        if(allKnown && total === eqObj.target){
          resDiv.textContent = "✅";
          resDiv.classList.remove("status-bad");
          resDiv.classList.add("status-ok");
        } else {
          resDiv.textContent = "❌";
          resDiv.classList.remove("status-ok");
          resDiv.classList.add("status-bad");
        }
      });
    }

    // -----------------------
    // 8. CURRENT SOLVED PHRASE STRING
    // -----------------------
    function getCurrentSolvedPhrase(){
      const wordsSolved = currentPuzzle.phraseWords.map(wordArr => {
        return wordArr.map(em => {
          if(playerState[em].solved){
            return currentPuzzle.mapping[em].letter;
          } else {
            return "_";
          }
        }).join("");
      });
      return wordsSolved.join(" ");
    }

    // -----------------------
    // 9. HANDLE INPUT FROM USER
    // -----------------------
    function handleGuessInput(e){
      const em   = e.target.dataset.emoji;
      const kind = e.target.dataset.kind;

      if(playerState[em].solved){
        syncSolvedEmojiEverywhere(em);
        updateEquationsStatus();
        checkWin();
        return;
      }

      let val = e.target.value;

      if(kind === "letter"){
        val = val.toUpperCase().replace(/[^A-Z]/g,"").slice(0,1);
        e.target.value = val;
      } else {
        if(val !== ""){
          let n = parseInt(val,10);
          if(isNaN(n)) n = "";
          if(n < 0) n = 0;
          if(n > 9) n = 9;
          e.target.value = n === "" ? "" : String(n);
          val = e.target.value;
        }
      }

      const correctLetter = currentPuzzle.mapping[em].letter;
      const correctNumber = String(currentPuzzle.mapping[em].number);

      const solvedByLetter = (kind==="letter" && val === correctLetter);
      const solvedByNumber = (kind==="number" && val === correctNumber);

      if(solvedByLetter || solvedByNumber){
        playerState[em].solved  = true;
        playerState[em].letter  = correctLetter;
        playerState[em].number  = correctNumber;
        syncSolvedEmojiEverywhere(em);
      } else {
        if(kind === "letter"){
          playerState[em].letter = val;
        } else {
          playerState[em].number = val;
        }
      }

      updateEquationsStatus();
      renderSolutionBox();
      checkWin();
    }

    // -----------------------
    // 10. SYNC SOLVED EMOJI
    // -----------------------
    function syncSolvedEmojiEverywhere(em){
      const correctLetter = currentPuzzle.mapping[em].letter;
      const correctNumber = String(currentPuzzle.mapping[em].number);
      playerState[em].solved  = true;
      playerState[em].letter  = correctLetter;
      playerState[em].number  = correctNumber;

      const phraseInputs = phraseArea.querySelectorAll(`.char-input[data-emoji="${em}"]`);
      phraseInputs.forEach(inp=>{
        inp.value = correctLetter;
        inp.disabled = true;
      });

      const eqInputs = equationsArea.querySelectorAll(`.num-input[data-emoji="${em}"]`);
      eqInputs.forEach(inp=>{
        inp.value = correctNumber;
        inp.disabled = true;
      });

      renderSolutionBox();
    }

    // -----------------------
    // 11. CONFETTI
    // -----------------------
// ---------- CONFETTI ENGINE (canvas-based) ----------

// We'll keep a single particle burst at a time.
function launchConfetti() {
  // block auto-repeat on win unless manually forced with Test Confetti
  if (hasCelebrated && !window._forceConfetti) return;
  hasCelebrated = true;

  // 1. Show the big "YOU SOLVED IT!" message
  const msg = document.getElementById("solvedMessage");
  if (msg) {
    // force it on
    msg.classList.add("show");

    // hide it after 2.5s
    setTimeout(() => {
      msg.classList.remove("show");
    }, 2500);
  }

  // 2. Confetti canvas setup
  const canvas = document.getElementById("confettiCanvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resizeCanvas();

  // ... keep the rest of the particle code exactly as before ...


  // show "YOU SOLVED IT" message
const msg = document.getElementById("solvedMessage");
if (msg) {
  msg.classList.add("show");
  // fade it out after 2.5 seconds
  setTimeout(() => {
    msg.classList.remove("show");
  }, 2500);
}
  
  // -----------------------
  // 1. Create particle sprites (offscreen emoji bitmaps)
  // -----------------------

  const EMOJIS = [
    "🎉","🎊","✨","💥","💫","🌟","🔥","🤩","😎","🦄",
    "🦊","🐸","🪐","🎲","🚀","★","🔮","🧊","🐙","🌸",
    "🦩","🐢","🪼","🐍", "🏵️"
  ];

  // We'll pre-render each emoji at a base size to its own tiny canvas.
  // That way in the main loop we're just drawing images, which is fast.
  function makeEmojiSprite(char, sizePx) {
    const off = document.createElement("canvas");
    const offCtx = off.getContext("2d");

    // give padding so rotation doesn't clip
    const pad = sizePx;
    off.width = sizePx + pad * 2;
    off.height = sizePx + pad * 2;

    offCtx.font = `${sizePx}px sans-serif`;
    offCtx.textAlign = "center";
    offCtx.textBaseline = "middle";
    offCtx.fillText(char, off.width / 2, off.height / 2);

    return {
      canvas: off,
      w: off.width,
      h: off.height,
      baseSize: sizePx
    };
  }

  // cache a few sprite sizes so particles can reuse them
  const SPRITES = [];
  for (let i = 0; i < EMOJIS.length; i++) {
    // randomize size a little so the burst isn't uniform
    const sizePx = 28 + Math.random() * 10; // 28-38px
    SPRITES.push(makeEmojiSprite(EMOJIS[i], sizePx));
  }

  // -----------------------
  // 2. Build particles
  // -----------------------

  const particles = [];
  const COUNT = 60; // slightly fewer for smoother perf

  // origin = bottom center
  const originX = canvas.width * 0.5;
  const originY = canvas.height * 0.9;

  for (let i = 0; i < COUNT; i++) {
    const sprite = SPRITES[Math.floor(Math.random() * SPRITES.length)];

    // Angle between -150° and -30° so they all go upward/outward
    const angleDeg = -150 + Math.random() * 120; // -150..-30
    const angleRad = angleDeg * Math.PI / 180;

    // Speed in px/sec
    const speed = 550 + Math.random() * 450; // 550-1000

    // Velocity components
    const vx = Math.cos(angleRad) * speed;
    const vy = Math.sin(angleRad) * speed;

    // Spin speed (deg/sec)
    const spinSpeed = (Math.random() * 720 - 360);

    // How long it lives (ms)
    const life = 2200 + Math.random() * 400; // 2.2s - 2.6s

    // Start jitter
    const startX = originX + (Math.random() - 0.5) * 30;
    const startY = originY + (Math.random() - 0.5) * 15;

    particles.push({
      sprite,
      x: startX,
      y: startY,
      vx,
      vy,
      spin: 0,
      spinSpeed,
      scaleStart: 1.0,
      scaleEnd: 0.5,
      alpha: 1,
      age: 0,     // ms since birth
      life,
      dead: false
    });
  }

  // -----------------------
  // 3. Animate with delta time for smoothness
  // -----------------------

  let running = true;
  let prevTS = performance.now();

  function frame(now) {
    if (!running) return;
    const dt = now - prevTS; // ms since last frame
    prevTS = now;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    let aliveCount = 0;

    for (const p of particles) {
      if (p.dead) continue;

      // advance particle
      p.age += dt;
      if (p.age >= p.life) {
        p.dead = true;
        continue;
      }
      aliveCount++;

      const tNorm = p.age / p.life; // 0 -> 1

      // position update using velocity and dt (smooth motion, independent of frame hiccups)
      p.x += p.vx * (dt / 1000);
      p.y += p.vy * (dt / 1000);

      // no gravity at all = no pooling at bottom
      // could add very tiny upward bias if you want longer lift, but not needed

      // spin update
      p.spin += p.spinSpeed * (dt / 1000);

      // scale shrinks over life
      const scale = p.scaleStart + (p.scaleEnd - p.scaleStart) * tNorm;

      // alpha: stay solid until 70%, then fade out by 100%
      if (tNorm < 0.7) {
        p.alpha = 1;
      } else {
        const tail = (tNorm - 0.7) / 0.3; // 0..1
        p.alpha = 1 - tail;
        if (p.alpha < 0) p.alpha = 0;
      }

      // draw
      ctx.save();
      ctx.globalAlpha = p.alpha;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.spin * Math.PI / 180);
      ctx.scale(scale, scale);

      // center the sprite so rotation happens around middle
      ctx.drawImage(
        p.sprite.canvas,
        -p.sprite.w / 2,
        -p.sprite.h / 2,
        p.sprite.w,
        p.sprite.h
      );

      ctx.restore();
    }

    if (aliveCount === 0) {
      // done: clear and stop
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      running = false;
      return;
    }

    requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);
}

    // -----------------------
    // 12. CHECK WIN
    // -----------------------
   function checkWin(){
  const finalPhrase = getCurrentSolvedPhrase();
  const phraseDone = (finalPhrase === currentPuzzle.phrase);

  let allEqCorrect = true;
  currentPuzzle.equations.forEach((eqObj, eqIndex)=>{
    const resDiv = equationsArea.querySelector(`.eq-result[data-eq-index="${eqIndex}"]`);
    if(!resDiv || !resDiv.classList.contains("status-ok")){
      allEqCorrect = false;
    }
  });

  if (phraseDone && allEqCorrect) {
    if (winBox) {
      winBox.style.display = "block";
    }
    if (!hasCelebrated) {
      launchConfetti();
    }
  } else {
    if (winBox) {
      winBox.style.display = "none";
    }
  }
}

    // -----------------------
    // 13. LOAD PUZZLE (Prev/Next)
    // -----------------------
    function loadPuzzle(index){
      if (index < 0) index = 0;
      if (index > PUZZLES.length - 1) index = PUZZLES.length - 1;
      currentIndex = index;
      currentPuzzle = PUZZLES[currentIndex];
      hasCelebrated = false;

      // reset playerState for new puzzle
      for (const key of Object.keys(playerState)) {
        delete playerState[key];
      }
      currentPuzzle.uniqueEmojis.forEach(em=>{
        playerState[em] = { letter:"", number:"", solved:false };
      });

      // draw UI fresh
      renderPhrase();
      renderEquations();
      renderSolutionBox();

      // label
      if (puzzleLabel) {
        puzzleLabel.textContent = `Puzzle ${currentIndex+1} / ${PUZZLES.length}`;
      }
    }

    // -----------------------
    // 14. INIT
    // -----------------------
    function init(){
      loadPuzzle(0); // show first puzzle on load
    }

    init();

const testConfettiBtn = document.getElementById("testConfettiBtn");
if (testConfettiBtn) {
  testConfettiBtn.addEventListener("click", () => {
    window._forceConfetti = true;
    launchConfetti();
    window._forceConfetti = false;
  });
}

    // After init, hook up buttons
    if (prevBtn) {
      prevBtn.addEventListener("click", ()=>{
        loadPuzzle(currentIndex - 1);
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", ()=>{
        loadPuzzle(currentIndex + 1);
      });
    }

  })();
  </script>
</body>
</html>
